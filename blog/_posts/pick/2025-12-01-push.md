---
layout: post
title: "Push Notification 기능 구현"
date: 2025-12-01 23:16:00 +0900
description: >
categories: [pick]
tags: [amplify, lambda, fcm, firebase]
---

# AWS End User Messaging & Flutter Push Notification 구현기

채팅 기능에 필수적인 push 알림을 구현하는 과정에 대해서 알아봅시다.

## 1. AWS End User Messaging (Backend)

AWS Pinpoint(End User Messaging)를 사용하여 푸시 알림을 발송하는 Lambda Function을 구현했습니다.

### `amplify/functions/pushNotification/handler.ts`

이 핸들러는 DynamoDB에서 타겟 유저의 정보를 조회한 후, `AWS.Pinpoint` SDK를 사용하여 메시지를 발송합니다.

```typescript
import { DynamoDBClient, GetItemCommand } from "@aws-sdk/client-dynamodb";
import AWS from "aws-sdk";
// ... (DynamoDB Client setup)
export const handler = async (event: any) => {
  // 1. Fetch User from DynamoDB
  // ... (GetItemCommand logic)

  const recipient = item as Record<string, any>;
  var messageRequest = CreateMessageRequest(recipient);
  // 2. Send Message via Pinpoint
  var pinpoint = new AWS.Pinpoint();
  var params = {
    ApplicationId: applicationId as string,
    MessageRequest: messageRequest as MessageRequest,
  };
  pinpoint.sendMessages(params, function (err, data) {
    if (err) console.log(err);
    else ShowOutput(data, recipient);
  });
  return event.prev.result;
};
```

## 2. Flutter Firebase Messaging (Client)

Flutter 앱에서는 `firebase_messaging` 패키지를 사용하여 알림을 수신합니다.

### `lib/core/services/push_service.dart`

앱 실행 시 권한을 요청하고, Foreground 및 Background 상태에서의 메시지 수신을 처리합니다.

```dart
@lazySingleton
class PushService {
  FirebaseMessaging messaging = FirebaseMessaging.instance;
  Future<void> init() async {
    // 1. Request Permission
    final NotificationSettings settings = await messaging.requestPermission(
      alert: true,
      badge: true,
      sound: true,
    );
    // 2. Listen for Foreground Messages
    FirebaseMessaging.onMessage.listen((RemoteMessage message) {
      safePrint('[DEBUG] Got a message whilst in the foreground!');
      if (message.notification != null) {
        safePrint('[DEBUG] Message also contained a notification: ${message.notification}');
      }
    });
    // 3. Setup Background/Terminated Handler
    await setupInteractedMessage();
  }
  // ... (Token registration logic)
}
```

## 3. CLI를 통한 Push Notification 테스트

개발 과정에서 `myfile.json`에 정의된 페이로드를 사용하여 CLI로 직접 푸시 알림을 테스트했습니다.

### `myfile.json`

```json
{
  "Addresses": {
    "<DEVICE_TOKEN>": {
      "ChannelType": "GCM"
    }
  },
  "MessageConfiguration": {
    "GCMMessage": {
      "RawContent": "{\"notification\":{\"title\":\"My sample message\",\"body\":\"This is a sample message\"},\"data\":{\"type\":\"chat\",\"roomId\":\"123\"}}"
    }
  }
}
```

### 실행 명령어

```bash
aws pinpoint send-messages \
    --application-id <YOUR_APP_ID> \
    --message-request file://myfile.json \
    --region <YOUR_REGION>
```

---

## Issue: Pinpoint GCMMessage Notification Display

### 문제 상황

Pinpoint를 통해 `GCMMessage`를 보낼 때, 일반적인 방식(Action, Body, Title 필드 사용)으로 전송하면 디바이스에서 푸시 알림이 정상적으로 표시되지 않는 문제가 발생했습니다.
확인 결과, 메시지 내용이 `message.notification`에 담기지 않고 `message.data.pinpoint.notification`이라는 커스텀 데이터 경로에 담겨서 전달되고 있었습니다. 이로 인해 시스템 트레이에 알림이 자동으로 뜨지 않았습니다.

### 해결 방법

이 문제를 해결하기 위해 **`RawContent`** 필드를 사용하여 FCM 페이로드 구조를 직접 정의하는 방식을 사용했습니다.
`RawContent`에 JSON 문자열로 `notification` 필드와 `data` 필드를 명시적으로 구성하여 넣어줌으로써, 수신 측(FCM)에서 표준 알림 메시지로 인식하도록 처리했습니다.
**수정된 Payload 구조 (RawContent 사용):**

```json
"RawContent": "{\"notification\":{\"title\":\"...\",\"body\":\"...\"},\"data\":{\"type\":\"...\"}}"
```

이렇게 함으로써 `message.notification`에 정상적으로 데이터가 담기게 되어, 백그라운드 상태에서도 알림이 정상적으로 표시되도록 수정했습니다.
