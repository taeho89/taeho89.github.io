<!--
Code for integrating CloudFlare's email protection with Hydejack's single page app loading.
-->
<script>
  document.getElementById('_pushState')?.addEventListener('hy-push-state-after', function (e) {
    function logErr(e){ (console.error?console.error:console.log).call(console,e) }
    function t(e){ 
      var l=document.createElement("div");
      return l.innerHTML='<a href="'+e.replace(/"/g,"&quot;")+'"></a>',l.childNodes[0].getAttribute("href")
    }
    function r(e,t){ var r=e.substr(t,2); return parseInt(r,16) }
    function n(e,n){
      for(var o="",c=r(e,n),a=n+2;a<e.length;a+=2){
        var l=r(e,a)^c;
        o+=String.fromCharCode(l)
      }
      return t(o)
    }
    var o="/cdn-cgi/l/email-protection#", c=".__cf_email__", a="data-cfemail";
    !function(){
      for(var t=document.getElementsByTagName("a"),r=0;r<t.length;r++)
        try{
          var cur=t[r],idx=cur.href.indexOf(o);
          idx>-1&&(cur.href="mailto:"+n(cur.href,idx+o.length))
        }catch(t){ logErr(t) }
    }(),
    function(){
      for(var t=document.querySelectorAll(c),r=0;r<t.length;r++)
        try{
          var o=t[r],l=n(o.getAttribute(a),0),i=document.createTextNode(l);
          o.parentNode.replaceChild(i,o)
        }catch(t){ logErr(t) }
    }()
  });
</script>

<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

  mermaid.initialize({ startOnLoad: false, theme: 'default', securityLevel: 'loose' });

  async function renderMermaid() {
    const elements = document.querySelectorAll('pre.language-mermaid, .language-mermaid pre, code.language-mermaid');
    for (const el of elements) {
      if (el.getAttribute('data-processed')) continue;
      const code = (el.innerText || el.textContent).trim();
      const id = 'm' + Math.random().toString(36).substring(2, 11);
      try {
        const { svg } = await mermaid.render(id, code);
        const container = el.closest('pre') || el;
        const wrapper = document.createElement('div');
        wrapper.className = 'mermaid-rendered';
        wrapper.innerHTML = svg;
        
        wrapper.addEventListener('click', () => openMermaidModal(svg));
        wrapper.style.cursor = 'zoom-in';

        container.parentNode.replaceChild(wrapper, container);
        el.setAttribute('data-processed', 'true');
      } catch (err) { console.error('Mermaid Error:', err); }
    }
  }

  function openMermaidModal(svgContent) {
    const modal = document.getElementById('mermaid-modal');
    const content = document.getElementById('mermaid-modal-content');
    content.innerHTML = svgContent;
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  function closeMermaidModal() {
    const modal = document.getElementById('mermaid-modal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }

  window.addEventListener('load', () => {
    const modal = document.createElement('div');
    modal.id = 'mermaid-modal';
    modal.innerHTML = '<div id="mermaid-modal-content"></div><div id="mermaid-modal-close">&times;</div>';
    document.body.appendChild(modal);

    modal.addEventListener('click', closeMermaidModal);
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.style.display === 'flex') {
        closeMermaidModal();
      }
    });
  });

  if (document.readyState === 'complete') renderMermaid();
  else window.addEventListener('load', renderMermaid);
  document.getElementById('_pushState')?.addEventListener('hy-push-state-after', () => setTimeout(renderMermaid, 200));
</script>

<style>
  /* 기본 차트 스타일 */
  .mermaid-rendered { display: flex; justify-content: center; background: white; padding: 20px; border-radius: 8px; margin: 20px 0; }
  .mermaid-rendered svg { max-width: 100%; height: auto; }

  /* 확대 모달 스타일 */
  #mermaid-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    background-color: rgba(0, 0, 0, 0.7);
    align-items: center;
    justify-content: center;
  }
  #mermaid-modal-content {
    width: 90%;
    height: 85%;
    /* max-width: 1200px;
    max-height: 800px; */
    background-color: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  #mermaid-modal-content svg {
    width: 100%;
    height: auto;
    max-height: 100%;
  }
  #mermaid-modal-close {
    position: absolute;
    top: 10px;
    right: 20px;
    color: #333;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
    z-index: 10000;
    transition: color 0.2s;
  }
  #mermaid-modal-close:hover {
    color: #000;
  }
</style>

{% comment %}
<!--
Example code for using Matamo as alternative analytics solution.
-->
{% if site.matomo_analytics %}
<script>
  var _paq = _paq || [];

  /*{% if site.matomo_analytics.no_cookies %}*/
  _paq.push(['disableCookies']);
  /*{% endif %}*/

  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  _paq.push(['setTrackerUrl', u+'piwik.php']);
  _paq.push(['setSiteId', '{{site.matomo_analytics.site_id}}']);

  var pushStateEl = document.getElementById('_pushState');
  var timeStartLoadPage, referer, timeItTookToLoadPage;

  pushStateEl.addEventListener('hy-push-state-start', function() {
    timeStartLoadPage = new Date().getTime();
    referer = window.location.toString();
  });

  pushStateEl.addEventListener('hy-push-state-ready', function() {
    timeItTookToLoadPage = new Date().getTime() - timeStartLoadPage;
  });

  pushStateEl.addEventListener('hy-push-state-after', function() {
    _paq.push(['setReferrerUrl', referer]);
    _paq.push(['setCustomUrl', window.location.toString()]);
    _paq.push(['setDocumentTitle', document.title]);
    _paq.push(['deleteCustomVariables', 'page']);
    _paq.push(['setGenerationTimeMs', timeItTookToLoadPage]);
    _paq.push(['trackPageView']);
  });

  window.loadJSDeferred('{{site.matomo_analytics.root}}piwik.js');
</script>
{% endif %}
{% endcomment %}
