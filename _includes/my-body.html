<!--
Code for integrating CloudFlare's email protection with Hydejack's single page app loading.
-->
<script>
  document.getElementById('_pushState')?.addEventListener('hy-push-state-after', function (e) {
    function logErr(e){ (console.error?console.error:console.log).call(console,e) }
    function t(e){ 
      var l=document.createElement("div");
      return l.innerHTML='<a href="'+e.replace(/"/g,"&quot;")+'"></a>',l.childNodes[0].getAttribute("href")
    }
    function r(e,t){ var r=e.substr(t,2); return parseInt(r,16) }
    function n(e,n){
      for(var o="",c=r(e,n),a=n+2;a<e.length;a+=2){
        var l=r(e,a)^c;
        o+=String.fromCharCode(l)
      }
      return t(o)
    }
    var o="/cdn-cgi/l/email-protection#", c=".__cf_email__", a="data-cfemail";
    !function(){
      for(var t=document.getElementsByTagName("a"),r=0;r<t.length;r++)
        try{
          var cur=t[r],idx=cur.href.indexOf(o);
          idx>-1&&(cur.href="mailto:"+n(cur.href,idx+o.length))
        }catch(t){ logErr(t) }
    }(),
    function(){
      for(var t=document.querySelectorAll(c),r=0;r<t.length;r++)
        try{
          var o=t[r],l=n(o.getAttribute(a),0),i=document.createTextNode(l);
          o.parentNode.replaceChild(i,o)
        }catch(t){ logErr(t) }
    }()
  });
</script>
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

  // 1. 초기화
  mermaid.initialize({
    startOnLoad: false,
    theme: 'default',
    securityLevel: 'loose',
    logLevel: 'debug' // 콘솔에서 에러를 더 자세히 보기 위함
  });

  const renderMermaid = async () => {
    console.log("Mermaid 렌더링 시도 중...");
    
    // Hydejack에서 생성하는 다양한 코드 블록 패턴을 모두 잡습니다.
    const elements = document.querySelectorAll('pre.language-mermaid, .language-mermaid pre, code.language-mermaid, .mermaid');
    
    if (elements.length === 0) {
      console.log("렌더링할 Mermaid 블록을 찾지 못했습니다.");
      return;
    }

    for (const el of elements) {
      // 이미 렌더링된 것은 건너뜀
      if (el.getAttribute('data-processed')) continue;

      const code = el.innerText || el.textContent;
      const id = 'mermaid-' + Math.random().toString(36).substr(2, 9);
      
      try {
        const { svg } = await mermaid.render(id, code);
        
        // 부모 중 가장 가까운 pre 태그를 찾거나 없으면 본인을 교체
        const container = el.closest('pre') || el;
        const wrapper = document.createElement('div');
        wrapper.className = 'mermaid-rendered';
        wrapper.innerHTML = svg;
        
        container.parentNode.replaceChild(wrapper, container);
        console.log(`${id} 렌더링 성공`);
      } catch (err) {
        console.error('Mermaid 개별 렌더링 에러:', err);
      }
    }
  };

  // 2. 실행 타이밍 (Hydejack 전용 이벤트 포함)
  
  // 첫 로드 시
  if (document.readyState === 'complete') {
    renderMermaid();
  } else {
    window.addEventListener('load', renderMermaid);
  }

  // Hydejack SPA 페이지 전환 후 (매우 중요)
  document.getElementById('_pushState')?.addEventListener('hy-push-state-after', () => {
    // 페이지 전환 후 약간의 지연을 주어 DOM이 완전히 준비되게 함
    setTimeout(renderMermaid, 100);
  });
</script>

<style>
  /* 렌더링된 차트가 너무 작게 나오지 않도록 스타일 추가 */
  .mermaid-rendered {
    display: flex;
    justify-content: center;
    background-color: white; /* 어두운 테마 사용 시 가독성을 위해 */
    padding: 1rem;
    border-radius: 0.5rem;
    margin: 1rem 0;
  }
  .mermaid-rendered svg {
    max-width: 100%;
    height: auto;
  }
</style>

{% comment %}
<!--
Example code for using Matamo as alternative analytics solution.
-->
{% if site.matomo_analytics %}
<script>
  var _paq = _paq || [];

  /*{% if site.matomo_analytics.no_cookies %}*/
  _paq.push(['disableCookies']);
  /*{% endif %}*/

  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  _paq.push(['setTrackerUrl', u+'piwik.php']);
  _paq.push(['setSiteId', '{{site.matomo_analytics.site_id}}']);

  var pushStateEl = document.getElementById('_pushState');
  var timeStartLoadPage, referer, timeItTookToLoadPage;

  pushStateEl.addEventListener('hy-push-state-start', function() {
    timeStartLoadPage = new Date().getTime();
    referer = window.location.toString();
  });

  pushStateEl.addEventListener('hy-push-state-ready', function() {
    timeItTookToLoadPage = new Date().getTime() - timeStartLoadPage;
  });

  pushStateEl.addEventListener('hy-push-state-after', function() {
    _paq.push(['setReferrerUrl', referer]);
    _paq.push(['setCustomUrl', window.location.toString()]);
    _paq.push(['setDocumentTitle', document.title]);
    _paq.push(['deleteCustomVariables', 'page']);
    _paq.push(['setGenerationTimeMs', timeItTookToLoadPage]);
    _paq.push(['trackPageView']);
  });

  window.loadJSDeferred('{{site.matomo_analytics.root}}piwik.js');
</script>
{% endif %}
{% endcomment %}
