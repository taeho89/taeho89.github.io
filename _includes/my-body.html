<!--
Code for integrating CloudFlare's email protection with Hydejack's single page app loading.
-->
<script>
  document.getElementById('_pushState')?.addEventListener('hy-push-state-after', function (e) {
    function logErr(e){ (console.error?console.error:console.log).call(console,e) }
    function t(e){ 
      var l=document.createElement("div");
      return l.innerHTML='<a href="'+e.replace(/"/g,"&quot;")+'"></a>',l.childNodes[0].getAttribute("href")
    }
    function r(e,t){ var r=e.substr(t,2); return parseInt(r,16) }
    function n(e,n){
      for(var o="",c=r(e,n),a=n+2;a<e.length;a+=2){
        var l=r(e,a)^c;
        o+=String.fromCharCode(l)
      }
      return t(o)
    }
    var o="/cdn-cgi/l/email-protection#", c=".__cf_email__", a="data-cfemail";
    !function(){
      for(var t=document.getElementsByTagName("a"),r=0;r<t.length;r++)
        try{
          var cur=t[r],idx=cur.href.indexOf(o);
          idx>-1&&(cur.href="mailto:"+n(cur.href,idx+o.length))
        }catch(t){ logErr(t) }
    }(),
    function(){
      for(var t=document.querySelectorAll(c),r=0;r<t.length;r++)
        try{
          var o=t[r],l=n(o.getAttribute(a),0),i=document.createTextNode(l);
          o.parentNode.replaceChild(i,o)
        }catch(t){ logErr(t) }
    }()
  });
</script>

<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
  
  // Mermaid 초기화 설정
  mermaid.initialize({ 
    startOnLoad: false, 
    theme: 'default',
    securityLevel: 'loose' 
  });

  const renderMermaid = async () => {
    // 하이라이팅 엔진이 입혀져도 텍스트만 추출해서 렌더링
    const elements = document.querySelectorAll('.language-mermaid');
    for (const el of elements) {
      const code = el.innerText;
      const id = 'mermaid-' + Math.random().toString(36).substr(2, 9);
      try {
        const { svg } = await mermaid.render(id, code);
        // 코드 블록을 SVG로 교체
        const container = el.closest('pre') || el;
        container.innerHTML = svg;
        container.style.background = 'transparent';
        container.style.border = 'none';
      } catch (err) {
        console.error('Mermaid render error:', err);
      }
    }
  };

  // 초기 로드 시 실행
  if (document.readyState === 'complete') {
    renderMermaid();
  } else {
    window.addEventListener('load', renderMermaid);
  }

  // Hydejack SPA 페이지 전환 시 실행
  document.getElementById('_pushState')?.addEventListener('hy-push-state-load', renderMermaid);
</script>

{% comment %}
<!--
Example code for using Matamo as alternative analytics solution.
-->
{% if site.matomo_analytics %}
<script>
  var _paq = _paq || [];

  /*{% if site.matomo_analytics.no_cookies %}*/
  _paq.push(['disableCookies']);
  /*{% endif %}*/

  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  _paq.push(['setTrackerUrl', u+'piwik.php']);
  _paq.push(['setSiteId', '{{site.matomo_analytics.site_id}}']);

  var pushStateEl = document.getElementById('_pushState');
  var timeStartLoadPage, referer, timeItTookToLoadPage;

  pushStateEl.addEventListener('hy-push-state-start', function() {
    timeStartLoadPage = new Date().getTime();
    referer = window.location.toString();
  });

  pushStateEl.addEventListener('hy-push-state-ready', function() {
    timeItTookToLoadPage = new Date().getTime() - timeStartLoadPage;
  });

  pushStateEl.addEventListener('hy-push-state-after', function() {
    _paq.push(['setReferrerUrl', referer]);
    _paq.push(['setCustomUrl', window.location.toString()]);
    _paq.push(['setDocumentTitle', document.title]);
    _paq.push(['deleteCustomVariables', 'page']);
    _paq.push(['setGenerationTimeMs', timeItTookToLoadPage]);
    _paq.push(['trackPageView']);
  });

  window.loadJSDeferred('{{site.matomo_analytics.root}}piwik.js');
</script>
{% endif %}
{% endcomment %}
